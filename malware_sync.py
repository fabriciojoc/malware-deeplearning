# -*- coding: UTF-8 -*-.
#
# get .tgz.zip malwares from Lando
# files format: bb_2016-10-12.tgz.zip

from datetime import date, timedelta
import os
import subprocess

# current file to sync
# current_date = date(2016, 8, 16)
yesterday = date.today() - timedelta(days=1)

# while current_date <= yesterday:
try:
    file_name = yesterday.strftime("bb_%Y-%m-%d.tgz.zip")
    # source
    source = "ftpbb@200.238.144.2:/var/ftpbb/malware/"+file_name
    # destination
    destination = "/home/gregio/Binaries/BB/"

    # call scp and wait for response
    p = subprocess.Popen(["scp", source, destination])
    sts = os.waitpid(p.pid, 0)

    # extract .tgz.zip file
    os.chdir(destination)
    p = subprocess.Popen(["unzip", "-P", "nopassword", "-o", file_name])
    sts = os.waitpid(p.pid, 0)

    # extract .tgz files
    os.chdir(destination + "home/gas")
    extract_command = 'for arc in *.tgz; do   tar -xvzf "$arc"; done'
    p = subprocess.Popen(["/bin/bash", "-c", extract_command])
    sts = os.waitpid(p.pid, 0)

    # delete all .tgz files
    os.chdir(destination + "home/gas")
    extract_command = 'rm -rf *.tgz'
    p = subprocess.Popen(["/bin/bash", "-c", extract_command])
    sts = os.waitpid(p.pid, 0)

    # create new folder
    folder_name = yesterday.strftime("%Y-%m-%d")
    p = subprocess.Popen(["mkdir", destination+folder_name])
    sts = os.waitpid(p.pid, 0)

    # move files to this folder
    move_command = "find . -type f -print0 | xargs -0 mv -t " + destination + folder_name
    p = subprocess.Popen(["/bin/bash", "-c", move_command])
    sts = os.waitpid(p.pid, 0)

    # delete extracted folder and .tgz.zip
    os.chdir(destination)
    delete_command = 'rm -rf home'
    p = subprocess.Popen(["/bin/bash", "-c", delete_command])
    sts = os.waitpid(p.pid, 0)
    deletetgzzip_command = 'rm -rf *.tgz.zip'
    p = subprocess.Popen(["/bin/bash", "-c", deletetgzzip_command])
    sts = os.waitpid(p.pid, 0)

    # unzip and delete possible .zip files
    os.chdir(destination + folder_name)
    unzip_command = 'for arc in *.zip; do   unzip -P nopassword -o "$arc"; done'
    p = subprocess.Popen(["/bin/bash", "-c", unzip_command])
    sts = os.waitpid(p.pid, 0)
    deletezip_command = 'rm -rf *.zip'
    p = subprocess.Popen(["/bin/bash", "-c", deletezip_command])
    sts = os.waitpid(p.pid, 0)
except:
    print "Erro"
# current_date = current_date + timedelta(days=1)
